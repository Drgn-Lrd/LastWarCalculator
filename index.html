<!DOCTYPE html>
<html>
<head>
<title>Optoelectronic Lab Upgrade Calculator</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f4f4f4;
        display: flex;
        justify-content: center; /* Center the container horizontally */
        align-items: flex-start; /* Align to the top */
        min-height: 90vh; /* Ensure body takes up most of the viewport height */
        position: relative; /* Needed for absolute positioning of the language selector */
    }
    .container {
        max-width: 550px; /* Increased max-width for more room for wider elements */
        width: 100%; /* Ensure it uses available width up to max-width */
        margin: 20px; /* Added some margin around the container */
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: #fff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    h2 {
        text-align: center;
        margin-top: 0;
        margin-bottom: 20px; /* Adjusted margin for title */
        line-height: 1.2; /* Allow title to wrap gracefully */
    }
    .row {
        display: flex;
        align-items: center;
        margin-bottom: 8px; /* Reduced margin-bottom for tighter spacing */
    }
    /* Changed display labels to span to avoid label errors */
    .row .display-label { /* New class for labels for display spans */
        flex: 2;
        margin-right: 10px;
        min-width: 120px;
    }
    .row label { /* Original label for form fields */
        flex: 2;
        margin-right: 10px;
        min-width: 120px;
    }
    .row input[type="text"],
    .row select {
        flex: 3; /* Give inputs more space */
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box; /* Include padding and border in the element's total width */
        text-align: right; /* Align numbers to the right */
    }
    /* Specific styling for workshop input rows to create columns */
    .workshop-row {
        display: grid;
        /* Adjusted grid columns: Name | Level (narrow) | Held (wider) */
        grid-template-columns: 2.2fr 0.6fr 1.6fr; /* Total 4.4fr */
        gap: 10px; /* Space between columns */
        align-items: center;
        margin-bottom: 8px; /* Reduced margin-bottom for tighter spacing */
    }
    .workshop-row label { /* Label for workshop names (e.g., Quartz Workshop 1) */
        grid-column: 1;
        text-align: left;
        margin-right: 0; /* Remove flex margin */
        min-width: unset; /* Override general label min-width */
    }
    .workshop-row input {
        text-align: right;
        max-width: unset; /* Allow grid to manage width */
    }
    .workshop-row input[id^="level"] {
        grid-column: 2;
        width: 100%; /* Fill its grid cell */
    }
    .workshop-row input[id^="quartz"] {
        grid-column: 3;
        width: 100%; /* Fill its grid cell */
    }

    /* Specific width for the Time Zone Select dropdown */
    #timezoneSelect {
        max-width: 280px; /* Increased width to prevent text cutoff */
    }

    /* Specific width for Quartz Held and Quartz Needed inputs */
    #quartzHeldText,
    #quartzNeededText {
        max-width: 200px; /* Consistent width for both */
    }

    button {
        width: 100%;
        padding: 10px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 15px;
        font-size: 16px;
    }
    button:hover {
        background-color: #0056b3;
    }
    .header-row {
        font-weight: bold;
        margin-bottom: 5px;
        display: grid;
        /* Match workshop-row columns */
        grid-template-columns: 2.2fr 0.6fr 1.6fr;
        gap: 10px;
    }
    .header-row span:first-child { /* The empty span for layout */
        text-align: left;
        grid-column: 1;
    }
    .header-row strong { /* Changed labels to strong for header semantic */
        grid-column: auto; /* Let grid handle positioning */
        text-align: center;
    }
    .display-value {
        font-weight: bold;
        color: #333;
        flex: 2; /* Give display values space */
        text-align: right; /* Align to the right */
        padding: 8px; /* Match input padding for alignment */
        min-width: 150px; /* Ensure it doesn't wrap too much */
        box-sizing: border-box;
    }
    hr {
        border: 0;
        height: 1px;
        background: #eee;
        margin: 15px 0; /* Reduced margin for the horizontal rule */
    }

    /* --- Language Selector Container Styling --- */
    #language-selector-container {
        position: absolute;
        top: 20px; /* Distance from top */
        right: 20px; /* Distance from right */
        z-index: 1000; /* Ensure it's on top */
        display: flex; /* To align label and select horizontally */
        align-items: center;
        gap: 5px;
    }
    #language-selector-container label {
        margin: 0; /* Remove default label margin */
        flex: none; /* Don't let it grow/shrink */
    }
    #languageSelect {
        padding: 5px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #fff;
        cursor: pointer;
        min-width: 100px; /* Give it some minimum width */
    }
</style>
</head>
<body>

<div id="language-selector-container">
    <label for="languageSelect">Language:</label>
    <select id="languageSelect" tabindex="1">
        </select>
</div>

<div class="container">
    <h2 data-i18n="title">Time Until Optoelectronic Lab Can Be Upgraded</h2>

    <div class="header-row">
        <span></span>
        <strong id="header-level" data-i18n="headerLevel">Level</strong>
        <strong id="header-held" data-i18n="headerHeld">Held</strong>
    </div>

    <div class="workshop-row">
        <label id="workshop1-name" data-i18n="quartzWorkshop1">Quartz Workshop 1</label>
        <input type="text" id="level1" value="" onblur="updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="2" aria-labelledby="workshop1-name header-level" maxlength="2">
        <input type="text" id="quartz1" value="" onblur="expandDecimal(this); updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="3" aria-labelledby="workshop1-name header-held">
    </div>
    <div class="workshop-row">
        <label id="workshop2-name" data-i18n="quartzWorkshop2">Quartz Workshop 2</label>
        <input type="text" id="level2" value="" onblur="updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="4" aria-labelledby="workshop2-name header-level" maxlength="2">
        <input type="text" id="quartz2" value="" onblur="expandDecimal(this); updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="5" aria-labelledby="workshop2-name header-held">
    </div>
    <div class="workshop-row">
        <label id="workshop3-name" data-i18n="quartzWorkshop3">Quartz Workshop 3</label>
        <input type="text" id="level3" value="" onblur="updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="6" aria-labelledby="workshop3-name header-level" maxlength="2">
        <input type="text" id="quartz3" value="" onblur="expandDecimal(this); updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="7" aria-labelledby="workshop3-name header-held">
    </div>
    <div class="workshop-row">
        <label id="workshop4-name" data-i18n="quartzWorkshop4">Quartz Workshop 4</label>
        <input type="text" id="level4" value="" onblur="updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="8" aria-labelledby="workshop4-name header-level" maxlength="2">
        <input type="text" id="quartz4" value="" onblur="expandDecimal(this); updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="9" aria-labelledby="workshop4-name header-held">
    </div>
    <div class="workshop-row">
        <label id="weekly-name" data-i18n="weeklyWorkshop">Weekly Workshop</label>
        <input type="text" id="levelWeekly" value="" onblur="updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="10" aria-labelledby="weekly-name header-level" maxlength="2">
        <input type="text" id="quartzWeekly" value="" onblur="expandDecimal(this); updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="11" aria-labelledby="weekly-name header-held">
    </div>

    <hr>

    <div class="row">
        <span class="display-label" data-i18n="quartzPerHour">Quartz/hr:</span>
        <span id="quartzHrDisplay" class="display-value">0</span>
    </div>

    <div class="row">
        <label for="quartzHeldText" data-i18n="quartzHeld">Quartz Held:</label>
        <input type="text" id="quartzHeldText" value="" onblur="updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="12">
    </div>

    <div class="row">
        <span class="display-label" data-i18n="totalQuartz">Total Quartz:</span>
        <span id="totalQuartzDisplay" class="display-value">0</span>
    </div>

    <div class="row">
        <label for="quartzNeededText" data-i18n="quartzNeeded">Quartz Needed:</label>
        <input type="text" id="quartzNeededText" value="" onblur="updateCalculations(this); formatInput(this)" onfocus="this.select()" tabindex="13">
    </div>

    <div class="row">
        <span class="display-label" data-i18n="timeToComplete">Time to Complete:</span>
        <span id="timeDisplay" class="display-value">N/A</span>
    </div>

    <div class="row">
        <span class="display-label" data-i18n="completionTime">Completion Time:</span>
        <span id="completionTimeDisplay" class="display-value">N/A</span>
    </div>

    <div class="row">
        <label for="timezoneSelect" data-i18n="displayTimeZone">Display Time Zone:</label>
        <select id="timezoneSelect" onchange="updateCalculations()" tabindex="14">
            </select>
    </div>

    <button onclick="updateCalculations()" tabindex="15" data-i18n="calculateButton">Calculate</button>
</div>

<script>
    // Define your translations
    const translations = {
        'en': { // English (default fallback)
            title: 'Time Until Optoelectronic Lab Can Be Upgraded',
            headerLevel: 'Level',
            headerHeld: 'Held',
            quartzWorkshop1: 'Quartz Workshop 1',
            quartzWorkshop2: 'Quartz Workshop 2',
            quartzWorkshop3: 'Quartz Workshop 3',
            quartzWorkshop4: 'Quartz Workshop 4',
            weeklyWorkshop: 'Weekly Workshop',
            quartzPerHour: 'Quartz/hr:',
            quartzHeld: 'Quartz Held:',
            totalQuartz: 'Total Quartz:',
            quartzNeeded: 'Quartz Needed:',
            timeToComplete: 'Time to Complete:',
            completionTime: 'Completion Time:',
            displayTimeZone: 'Display Time Zone:',
            calculateButton: 'Calculate'
        },
        'es': { // Spanish
            title: 'Tiempo hasta que el Laboratorio Optoelectrónico pueda ser mejorado',
            headerLevel: 'Nivel',
            headerHeld: 'Obtenido',
            quartzWorkshop1: 'Taller de Cuarzo 1',
            quartzWorkshop2: 'Taller de Cuarzo 2',
            quartzWorkshop3: 'Taller de Cuarzo 3',
            quartzWorkshop4: 'Taller de Cuarzo 4',
            weeklyWorkshop: 'Taller Semanal',
            quartzPerHour: 'Cuarzo/hora:',
            quartzHeld: 'Cuarzo Actual:',
            totalQuartz: 'Cuarzo Total:',
            quartzNeeded: 'Cuarzo Necesario:',
            timeToComplete: 'Tiempo Restante:',
            completionTime: 'Hora de Finalización:',
            displayTimeZone: 'Zona Horaria:',
            calculateButton: 'Calcular'
        },
        'pt': { // Portuguese (Placeholder translations)
            title: 'Tempo até o Laboratório Optoeletrônico Poder Ser Atualizado',
            headerLevel: 'Nível',
            headerHeld: 'Tido',
            quartzWorkshop1: 'Oficina de Quartzo 1',
            quartzWorkshop2: 'Oficina de Quartzo 2',
            quartzWorkshop3: 'Oficina de Quartzo 3',
            quartzWorkshop4: 'Oficina de Quartzo 4',
            weeklyWorkshop: 'Oficina Semanal',
            quartzPerHour: 'Quartzo/hr:',
            quartzHeld: 'Quartzo Atual:',
            totalQuartz: 'Quartzo Total:',
            quartzNeeded: 'Quartzo Necessário:',
            timeToComplete: 'Tempo para Concluir:',
            completionTime: 'Hora de Conclusão:',
            displayTimeZone: 'Fuso Horário:',
            calculateButton: 'Calcular'
        },
        'ko': { // Korean (Placeholder translations)
            title: '광전자 연구실 업그레이드까지 남은 시간',
            headerLevel: '레벨',
            headerHeld: '보유',
            quartzWorkshop1: '석영 작업장 1',
            quartzWorkshop2: '석영 작업장 2',
            quartzWorkshop3: '석영 작업장 3',
            quartzWorkshop4: '석영 작업장 4',
            weeklyWorkshop: '주간 작업장',
            quartzPerHour: '시간당 석영:',
            quartzHeld: '보유 석영:',
            totalQuartz: '총 석영:',
            quartzNeeded: '필요한 석영:',
            timeToComplete: '완료까지 남은 시간:',
            completionTime: '완료 시간:',
            displayTimeZone: '표시 시간대:',
            calculateButton: '계산'
        },
        'ja': { // Japanese (Placeholder translations)
            title: '光電子ラボアップグレードまでの時間',
            headerLevel: 'レベル',
            headerHeld: '所持',
            quartzWorkshop1: 'クォーツワークショップ 1',
            quartzWorkshop2: 'クォーツワークショップ 2',
            quartzWorkshop3: 'クォーツワークショップ 3',
            quartzWorkshop4: 'クォーツワークショップ 4',
            weeklyWorkshop: '週次ワークショップ',
            quartzPerHour: 'クォーツ/時:',
            quartzHeld: '所持クォーツ:',
            totalQuartz: '合計クォーツ:',
            quartzNeeded: '必要なクォーツ:',
            timeToComplete: '完了までの時間:',
            completionTime: '完了時刻:',
            displayTimeZone: '表示タイムゾーン:',
            calculateButton: '計算'
        }
    };

    // Function to apply translations based on a specified language or auto-detect
    function applyTranslations(langOverride = null) {
        let langToUse;

        if (langOverride) {
            langToUse = langOverride;
        } else if (document.getElementById('languageSelect') && document.getElementById('languageSelect').value) {
            langToUse = document.getElementById('languageSelect').value;
        } else {
            langToUse = navigator.language.split('-')[0];
        }

        const currentTranslations = translations[langToUse] || translations['en'];

        const languageSelect = document.getElementById('languageSelect');
        if (languageSelect && languageSelect.value !== langToUse) {
            languageSelect.value = langToUse;
        }

        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.getAttribute('data-i18n');
            if (currentTranslations[key]) {
                element.textContent = currentTranslations[key];
            }
        });

        const titleElement = document.querySelector('h2');
        if (titleElement && currentTranslations.title) {
            titleElement.textContent = currentTranslations.title;
        }

        const buttonElement = document.querySelector('button');
        if (buttonElement && currentTranslations.calculateButton) {
            buttonElement.textContent = currentTranslations.calculateButton;
        }
    }

    // Function to populate the language selection dropdown
    function populateLanguageSelector() {
        const languageSelect = document.getElementById('languageSelect');
        languageSelect.innerHTML = '';

        const languageNames = {
            'en': 'English',
            'es': 'Español',
            'pt': 'Português',
            'ko': '한국어',
            'ja': '日本語'
        };

        for (const langCode in translations) {
            if (translations.hasOwnProperty(langCode)) {
                const option = document.createElement('option');
                option.value = langCode;
                option.textContent = languageNames[langCode] || langCode;
                languageSelect.appendChild(option);
            }
        }

        const userBrowserLang = navigator.language.split('-')[0];
        if (languageSelect.querySelector(`option[value="${userBrowserLang}"]`)) {
            languageSelect.value = userBrowserLang;
        } else {
            languageSelect.value = 'en';
        }

        languageSelect.addEventListener('change', (event) => {
            applyTranslations(event.target.value);
            updateCalculations();
        });
    }

    // ######################### Helper Functions #########################

    /**
     * Expands a decimal number like 6.8 to 6800 for 'quartz' input fields.
     * Modifies the inputElement.value directly.
     */
    function expandDecimal(inputElement) {
        // Only apply to quartz inputs (quartz1-4, quartzWeekly, quartzHeldText)
        if (!inputElement.id.startsWith('quartz')) {
            return;
        }

        let value = inputElement.value.replace(/,/g, ''); // Remove commas for parsing
        const parsed = parseFloat(value);

        // Check if it's a number, contains a decimal, and has a fractional part (e.g., 6.0 is not 6.000)
        if (!isNaN(parsed) && value.includes('.') && parsed % 1 !== 0) {
            // Apply the specific expansion logic (e.g., 6.8 becomes 6800, 12.5 becomes 12500)
            // This implies multiplying by 1000 if a decimal is present and has a fractional part.
            inputElement.value = Math.round(parsed * 1000).toString();
        }
    }

    /**
     * Formats a number input with thousands separators.
     * Does NOT handle decimal expansion; expandDecimal does that beforehand.
     */
    function formatInput(inputElement) {
        let value = inputElement.value.replace(/[^0-9.]/g, ''); // Remove non-numeric except dot
        if (value === '') {
            inputElement.value = '';
            return;
        }
        let number = parseFloat(value);
        if (isNaN(number)) {
            inputElement.value = '';
            return;
        }

        // Determine if it should display decimals based on original input or if it's a whole number
        // After expandDecimal, most will be whole numbers, so default to 0 decimals for consistency.
        if (value.includes('.') || number % 1 !== 0) {
             // If original input contained a decimal or it's a floating point number after expansion,
             // allow 0-2 decimal places. This handles cases where user might enter 6.85 which becomes 6850.
            inputElement.value = number.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        } else {
            inputElement.value = number.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
    }

    // Function to get a cleaned number from a textbox (removes commas)
    // This function now assumes expandDecimal has already transformed the value if necessary.
    function getCleanNumber(id) {
        const inputElement = document.getElementById(id);
        if (!inputElement) return 0;
        const value = inputElement.value.replace(/,/g, ''); // Remove commas for calculation
        return parseFloat(value) || 0;
    }

    // ######################### Time Zone Logic #########################

    const curatedTimeZoneIds = [
        "Etc/UTC",
        "America/St_Johns",
        "America/Halifax",
        "America/New_York",
        "America/Indiana/Indianapolis",
        "America/Chicago",
        "America/Denver",
        "America/Phoenix",
        "America/Los_Angeles",
        "America/Anchorage",
        "America/Honolulu",
        "Asia/Tokyo"
    ];

    function getNumericalOffsetInHours(tzId) {
        try {
            const now = new Date();
            const offsetFormatter = new Intl.DateTimeFormat('en-US', {
                timeZone: tzId,
                timeZoneName: 'shortOffset',
            });
            const offsetString = offsetFormatter.format(now);

            if ((offsetString.includes('GMT') || offsetString.includes('UTC')) && !offsetString.match(/[+-]\d/)) {
                return 0;
            }

            const match = offsetString.match(/GMT\s*([+-]\d{1,2}(:\d{2})?)/);
            if (match && match[1]) {
                const offsetPart = match[1];
                const sign = offsetPart.startsWith('-') ? -1 : 1;
                const [hoursStr, minutesStr] = offsetPart.replace(/[+-]/, '').split(':');
                let totalHours = parseInt(hoursStr, 10);
                if (minutesStr) {
                    totalHours += parseInt(minutesStr, 10) / 60;
                }
                return sign * totalHours;
            } else {
                console.warn(`Could not parse numerical offset from: '${offsetString}' for '${tzId}'. No 'GMT+/-X' pattern found.`);
            }
        } catch (e) {
            console.error(`Error calculating offset for '${tzId}':`, e);
        }
        return 0;
    }

    function populateTimezones() {
        const timezoneSelect = document.getElementById('timezoneSelect');
        const now = new Date();
        const localTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

        timezoneSelect.innerHTML = '';

        const tempOptions = [];

        curatedTimeZoneIds.forEach(tzId => {
            let offsetHours = 0;
            let longTimeZoneName = tzId;
            let formattedOffset = `UTC+0`;

            try {
                new Intl.DateTimeFormat('en-US', { timeZone: tzId }).format(now); 

                offsetHours = getNumericalOffsetInHours(tzId);
                
                if (offsetHours === 0) {
                    formattedOffset = `UTC+0`;
                } else {
                    const offsetSign = offsetHours > 0 ? '+' : '-';
                    const absOffsetHours = Math.abs(offsetHours);
                    const integerHours = Math.floor(absOffsetHours);
                    const fractionalMinutes = (absOffsetHours % 1) * 60;

                    if (fractionalMinutes > 0) {
                        formattedOffset = `UTC${offsetSign}${integerHours}:${String(fractionalMinutes).padStart(2, '0')}`;
                    } else {
                        formattedOffset = `UTC${offsetSign}${integerHours}`;
                    }
                }

                const parts = new Intl.DateTimeFormat('en-US', {
                    timeZone: tzId,
                    timeZoneName: 'long',
                    year: 'numeric', month: 'numeric', day: 'numeric',
                    hour: 'numeric', minute: 'numeric', second: 'numeric'
                }).formatToParts(now);

                let foundTimeZoneNamePart = parts.find(part => part.type === 'timeZoneName');
                if (foundTimeZoneNamePart && typeof foundTimeZoneNamePart.value === 'string' && foundTimeZoneNamePart.value.trim() !== '') {
                    longTimeZoneName = foundTimeZoneNamePart.value;
                } else {
                    console.warn(`Could not extract long timeZoneName from parts for '${tzId}'. Falling back to ID.`);
                    longTimeZoneName = tzId;
                }

                if (tzId === "America/Phoenix") {
                    longTimeZoneName = "Arizona (Mountain)";
                } else if (tzId === "America/Indiana/Indianapolis") {
                    longTimeZoneName = "Indiana (East)";
                }

            } catch (e) {
                if (e instanceof RangeError && e.message.includes('Invalid time zone specified')) {
                    console.warn(`Time zone '${tzId}' is explicitly unsupported by the browser (RangeError). Adding a static fallback entry.`, e.message);
                } else {
                    console.error(`Error during dynamic time zone data calculation for '${tzId}'. Adding a static fallback entry.`, e);
                }
                
                if (tzId === "America/Honolulu") {
                    longTimeZoneName = "Hawaii";
                    formattedOffset = "UTC-10:00";
                    offsetHours = -10;
                } else if (tzId === "Etc/UTC") { 
                    longTimeZoneName = "Coordinated Universal Time";
                    formattedOffset = "UTC+0";
                    offsetHours = 0;
                } else {
                    longTimeZoneName = `${tzId} (Unsupported)`;
                    formattedOffset = `UTC+0`;
                    offsetHours = 0;
                }
            }

            tempOptions.push({
                id: tzId,
                name: `${longTimeZoneName} (${formattedOffset})`,
                offset: offsetHours
            });
        });

        tempOptions.sort((a, b) => {
            if (a.offset !== b.offset) {
                return a.offset - b.offset;
            }
            return a.name.localeCompare(b.name);
        });

        tempOptions.forEach(tzData => {
            const option = document.createElement('option');
            option.value = tzData.id;
            option.textContent = tzData.name;
            timezoneSelect.appendChild(option);
        });

        timezoneSelect.value = localTimeZone;

        if (timezoneSelect.value !== localTimeZone && tempOptions.length > 0) {
            const localOffset = getNumericalOffsetInHours(localTimeZone);
            let bestMatchIndex = 0;
            let minDiff = Infinity;

            for (let i = 0; i < tempOptions.length; i++) {
                const diff = Math.abs(tempOptions[i].offset - localOffset);
                if (diff < minDiff) {
                    minDiff = diff;
                    bestMatchIndex = i;
                }
            }
            timezoneSelect.selectedIndex = bestMatchIndex;
            console.warn(`Local timezone '${localTimeZone}' not directly in curated list or unsupported. Defaulting to closest offset: '${tempOptions[bestMatchIndex].name}'.`);
        }
    }


    // ######################### Main Calculation Logic #########################
    /**
     * Performs calculations and handles auto-population of quartz held values.
     * @param {HTMLElement} [triggeringElement=null] - The input element that triggered the update (e.g., onblur).
     */
    function updateCalculations(triggeringElement = null) {
        let totalQuartzFromWorkshops = 0;
        let totalWorkshopRate = 0;

        const workshopLevels = [
            document.getElementById('level1'),
            document.getElementById('level2'),
            document.getElementById('level3'),
            document.getElementById('level4'),
            document.getElementById('levelWeekly')
        ];
        const quartzWorkshops = [
            document.getElementById('quartz1'),
            document.getElementById('quartz2'),
            document.getElementById('quartz3'),
            document.getElementById('quartz4'),
            document.getElementById('quartzWeekly')
        ];

        // --- Auto-population Logic ---
        if (triggeringElement && triggeringElement.id.startsWith('quartz')) {
            const triggeredLevelId = 'level' + triggeringElement.id.replace('quartz', '');
            const triggeredLevelElement = document.getElementById(triggeredLevelId);
            const triggeredLevel = getCleanNumber(triggeredLevelId);
            const triggeredQuartzValue = getCleanNumber(triggeringElement.id);

            if (triggeredLevel > 0 && triggeredQuartzValue > 0) { // Only auto-populate if source level and quartz are valid
                for (let i = 0; i < quartzWorkshops.length; i++) {
                    const currentQuartzElement = quartzWorkshops[i];
                    const currentLevelElement = workshopLevels[i];

                    // Don't auto-populate the element that just triggered the update
                    if (currentQuartzElement.id === triggeringElement.id) {
                        continue;
                    }

                    const currentLevel = getCleanNumber(currentLevelElement.id);
                    const currentQuartzValue = getCleanNumber(currentQuartzElement.id);

                    // If levels match AND (target field is empty OR target field has the same value as source)
                    if (currentLevel > 0 && currentLevel === triggeredLevel &&
                        (currentQuartzValue === 0 || currentQuartzValue === triggeredQuartzValue)) {
                        
                        currentQuartzElement.value = triggeredQuartzValue.toString(); // Set the raw value
                        formatInput(currentQuartzElement); // Immediately format the auto-populated field
                    }
                }
            }
        }
        // --- End Auto-population Logic ---

        // --- Standard Calculations ---
        for (let i = 0; i < 5; i++) {
            let level = getCleanNumber(workshopLevels[i].id);
            if (level <= 30) { // Only levels up to 30 contribute to rate
                totalWorkshopRate += level;
            }
            let quartz = getCleanNumber(quartzWorkshops[i].id);
            totalQuartzFromWorkshops += quartz;
        }

        const quartzHeld = getCleanNumber('quartzHeldText');
        const quartzNeeded = getCleanNumber('quartzNeededText');

        const quartzPerHour = totalWorkshopRate * 720;
        document.getElementById('quartzHrDisplay').textContent = quartzPerHour.toLocaleString('en-US');

        const totalCurrentQuartz = quartzHeld + totalQuartzFromWorkshops;
        document.getElementById('totalQuartzDisplay').textContent = totalCurrentQuartz.toLocaleString('en-US');

        const timeDisplay = document.getElementById('timeDisplay');
        const completionTimeDisplay = document.getElementById('completionTimeDisplay');

        if (quartzPerHour > 0 && totalCurrentQuartz < quartzNeeded) {
            const hoursRequired = (quartzNeeded - totalCurrentQuartz) / quartzPerHour;
            timeDisplay.textContent = `${hoursRequired.toFixed(2)} hrs`;

            const completionDateTimeUtc = new Date(Date.now() + hoursRequired * 60 * 60 * 1000);
            
            const selectedTimeZone = document.getElementById('timezoneSelect').value;

            if (!selectedTimeZone) {
                console.error("No time zone selected in dropdown. Cannot display completion time.");
                completionTimeDisplay.textContent = "N/A (Select TZ)";
                return;
            }
            
            try {
                const formatter = new Intl.DateTimeFormat('en-US', {
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true,
                    timeZone: selectedTimeZone,
                    timeZoneName: 'short'
                });
                completionTimeDisplay.textContent = formatter.format(completionDateTimeUtc);
            } catch (e) {
                console.error(`Error formatting completion time for '${selectedTimeZone}'. Displaying UTC.`, e);
                const utcFormatter = new Intl.DateTimeFormat('en-US', {
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true,
                    timeZone: 'UTC',
                    timeZoneName: 'short'
                });
                completionTimeDisplay.textContent = `UTC: ${utcFormatter.format(completionDateTimeUtc)}`;
            }

        } else {
            timeDisplay.textContent = "N/A";
            completionTimeDisplay.textContent = "N/A";
        }
        // --- End Standard Calculations ---

        // Re-format the main quartzHeldText and quartzNeededText after calculations,
        // as they are not part of the auto-population loop for workshops.
        // Workshop quartz fields are formatted within the auto-population loop or by their own onblur.
        if (document.getElementById('quartzHeldText').value !== '') formatInput(document.getElementById('quartzHeldText'));
        if (document.getElementById('quartzNeededText').value !== '') formatInput(document.getElementById('quartzNeededText'));
        // Re-format level fields as well, if they were edited
        if (triggeringElement && triggeringElement.id.startsWith('level') && triggeringElement.value !== '') {
            formatInput(triggeringElement);
        }
    }

    // ######################### Initial Load #########################
    window.onload = () => {
        populateLanguageSelector();
        populateTimezones();
        applyTranslations();
        updateCalculations(); // Initial calculation and display update
    };
</script>

</body>
</html>
